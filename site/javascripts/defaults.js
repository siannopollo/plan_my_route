(function(){if(!this.Form){this.Form={}}var a=("placeholder" in document.createElement("input"));if(!("supportsPlaceholder" in this)&&this.supportsPlaceholder!==false&&a){this.Form.Placeholder=new Class({});return}this.Form.Placeholder=new Class({Implements:Options,options:{className:"placeholder",clearOnSubmit:false},initialize:function(c,b){this.setOptions(b);this.element=$(c);this.placeholder=this.element.get("placeholder");this.is_password=this.element.get("type")=="password"?true:false;this.activatePlaceholder();this.element.addEvents({focus:function(){this.deactivatePlaceholder()}.bind(this),blur:function(){this.activatePlaceholder()}.bind(this)});if(this.element.getParent("form")&&this.options.clearOnSubmit){this.element.getParent("form").addEvent("submit",function(d){if(this.element.get("value")==this.placeholder){this.element.set("value","")}}.bind(this))}},activatePlaceholder:function(){if(this.element.get("value")==""||this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","text")}this.element.addClass(this.options.className);this.element.set("value",this.placeholder)}},deactivatePlaceholder:function(){if(this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","password")}this.element.set("value","");this.element.removeClass(this.options.className)}}});Element.addEvent(window,"domready",function(b){$$("input[placeholder]").each(function(c){new Form.Placeholder(c)})})})();var PlanMyRoute={};var extensions={first:function(){return this[0]},last:function(){return this[this.length-1]}};for(var name in extensions){Array.implement(name,extensions[name]);Elements.implement(name,extensions[name])}PlanMyRoute.Address=new Class({initialize:function(a,c,b){this.element=a;this.route=c;this.start=b||false;this.coordinates=null,this.latitude=null,this.longitude=null,this.first=false,this.error=false;if(this.start){this.addStartMethods()}this.geocoder=this.route.geocoder;this.container=this.element.getParent(".set");this.assignElements();this.observeElements()},addAddress:function(a){this.route.createAddressAfter(this)},addStartMethods:function(){for(var a in PlanMyRoute.Address.StartMethods){this[a]=PlanMyRoute.Address.StartMethods[a].bind(this)}},assignElements:function(){this.makeFirstTrigger=this.container.getElement(".make_first");this.addAddressTrigger=this.container.getElement(".add");this.removeTrigger=this.container.getElement(".remove")},cachedLocationKey:function(){if(!this.hasText()){return""}return this.text().replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},distanceFrom:function(a){return this.geocoder.distanceFrom(this).to(a)},hasText:function(){var a=this.text();if(a==""||a==this.element.get("placeholder")){return false}return true},isCurrentLocationCached:function(){if(!this.hasText()){return false}var a=this.geocoder.addressLocationCache[this.cachedLocationKey()];if(a){this.coordinates=a}return !!a},isPlottable:function(){if(!this.coordinates){return false}return true},makeFirst:function(a){this.route.addresses.each(function(b){if(b!=this){b.container.removeClass("first");b.first=false}}.bind(this));this.container.toggleClass("first");this.first=!this.first},markError:function(){this.container.addClass("error");this.error=true},observeElements:function(){this.makeFirstTrigger.addEvent("click",this.makeFirst.bind(this));this.addAddressTrigger.addEvent("click",this.addAddress.bind(this));this.removeTrigger.addEvent("click",this.remove.bind(this))},remove:function(a){if(this.start){return false}if(this.route.addresses.length<=2){return false}this.container.dispose();this.route.addresses.erase(this);this.route.reorderPlaceholders()},removeErrors:function(){this.container.removeClass("error");this.error=false},retrieveCoordinates:function(a){if(!a){a=function(){}}if(this.hasText()&&!this.isCurrentLocationCached()){this.geocoder.geocodeFromAddress(this.text(),function(c,b){if(b==google.maps.GeocoderStatus.OK){var d=c[0].geometry.location;this.setCoordinates(d.lat(),d.lng());this.geocoder.cacheAddressLocation(this);this.removeErrors()}else{this.markError()}a()}.bind(this))}else{a();this.removeErrors()}},setCoordinates:function(b,a){this.coordinates=new PlanMyRoute.Coordinates(b,a);this.latitude=this.coordinates.latitude;this.longitude=this.coordinates.longitude},text:function(){return this.element.get("value").trim()}});PlanMyRoute.Address.StartMethods={assignElements:function(){},observeElements:function(){}};PlanMyRoute.Geocoder=new Class({initialize:function(){this._geocoder=new google.maps.Geocoder();this._addressForDistance=null;this.addressLocationCache={}},cacheAddressLocation:function(a){if(a.coordinates){this.addressLocationCache[a.cachedLocationKey()]=a.coordinates}},distanceFrom:function(a){this._addressForDistance=a;return this},geocode:function(a,b){return this._geocoder.geocode(a,b)},geocodeFromAddress:function(a,b){return this._geocoder.geocode({address:a},b)},geocodeFromCoordinates:function(a,b){return this._geocoder.geocode({latLng:a.latlng},b)},to:function(c){var b=this._addressForDistance.coordinates,a=c.coordinates;if(b&&a){return google.maps.geometry.spherical.computeDistanceBetween(b.latlng,a.latlng)}else{return null}}});PlanMyRoute.Coordinates=new Class({initialize:function(b,a){this.latitude=b;this.longitude=a;this.latlng=new google.maps.LatLng(this.latitude,this.longitude)}});PlanMyRoute.Map=new Class({initialize:function(b,a){this.route=b;this.container=a;this.element=this.container.getElement(".map");this.directionsPanel=this.container.getElement(".driving_directions");this.mapInitiated=false;this.mapLoaded=false;this.resetSources()},correctDirectionsMarkers:function(){setTimeout(function(){var a=this._sortImages(this.directionsPanel.getElements("img[src*=_green]"));if(!this.unwantedSrc.directions){this.unwantedSrc.directions=a.last().src}if(!this.desiredSrc.directions){this.desiredSrc.directions=a.first().src}a.each(function(b){if(b.src==this.unwantedSrc.directions){b.src=this.desiredSrc.directions}}.bind(this));if(this.mapLoaded){this.correctMapMarkers(true)}}.bind(this),1000)},correctMapMarkers:function(b){var a=function(){var c=this._sortImages(this.element.getElements("img[src*=_green]"));if(!this.unwantedSrc.map){this.unwantedSrc.map=c.last().src}if(!this.desiredSrc.map){this.desiredSrc.map=c.first().src}c.each(function(d){if(d.src==this.unwantedSrc.map){d.src=this.desiredSrc.map}}.bind(this))}.bind(this);if(b){a()}else{setTimeout(a,1000)}},resetSources:function(){this.desiredSrc={map:null,directions:null};this.unwantedSrc={map:null,directions:null}},mapDidLoad:function(){this.mapLoaded=true},plotAddresses:function(a,b){this.container.removeClass("hide");this.resetSources();if(!this.mapInitiated){this.map=new google.maps.Map(this.element,{center:a[0].coordinates.latlng,mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false});this.renderer=new google.maps.DirectionsRenderer({draggable:true,map:this.map,panel:this.directionsPanel,markerOptions:{draggable:false}});google.maps.event.addListener(this.renderer,"directions_changed",this.correctDirectionsMarkers.bind(this));google.maps.event.addListener(this.map,"tilesloaded",this.mapDidLoad.bind(this));google.maps.event.addListener(this.map,"idle",this.correctMapMarkers.bind(this));this.mapInitiated=true}new google.maps.DirectionsService().route(this.request(a),function(c,d){if(d==google.maps.DirectionsStatus.OK){this.renderer.setDirections(c)}if(b){b()}}.bind(this))},request:function(c){var b=c[0],d=c.slice(1,c.length),a={travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,waypoints:[]};a.origin=b.text();a.destination=b.text();d.each(function(e){a.waypoints.push({location:e.text(),stopover:true})});return a},_sortImages:function(a){var b=a.map(function(d){return d.src}),c=[];b=b.sort();b.each(function(d){a.each(function(e){if(e.src==d){c.push(e)}})});return c}});PlanMyRoute.Plan=new Class({initialize:function(a){this.route=a;this.geocoder=this.route.geocoder;this.map=this.route.map;this.addresses=[];this.totalGeocodeCount=0;this.geocodeCount=0},execute:function(a){this.callbackAfterMapping=a;this.geocodeAddresses()},geocodeAddresses:function(){this.totalGeocodeCount=this.route.addresses.length;this.geocodeCount=0;this.route.addresses.each(function(a){a.retrieveCoordinates(this.notifyGeocoding.bind(this))}.bind(this))},notifyGeocoding:function(){this.geocodeCount++;if(this.geocodeCount>=this.totalGeocodeCount){this.totalGeocodeCount=0;this.geocodeCount=0;this.selectPlottableAddresses();if(this.route.isOptimized()){this.orderAddresses()}if(this.addresses.length>1){this.map.plotAddresses(this.addresses,this.callbackAfterMapping)}else{this.callbackAfterMapping()}}},orderAddresses:function(){if(this.addresses.contains(this.route.startingAddress)){this.sortedAddresses=[this.route.startingAddress];this.addresses.erase(this.route.startingAddress);if(this.route.firstAddress()){var a=this.route.firstAddress();this.sortedAddresses.push(a);this.addresses.erase(a)}var e=this.addresses.length;for(var d=0;d<e;d++){var b=this.addresses.sort(this._sortingFunction.bind(this));var c=b[0];this.addresses.erase(c);this.sortedAddresses.push(c)}this.addresses=this.sortedAddresses}else{}},selectPlottableAddresses:function(){this.route.addresses.each(function(a){if(a.isPlottable()){this.addresses.push(a)}}.bind(this))},_sortingFunction:function(c,g){var f=this.sortedAddresses[this.sortedAddresses.length-1];var d=this.geocoder.distanceFrom(c).to(f),e=this.geocoder.distanceFrom(g).to(f);return d-e}});PlanMyRoute.Route=new Class({initialize:function(a){this.container=a;this.geocoder=new PlanMyRoute.Geocoder();this.registerAddresses();this.startingAddress=this.addresses[0];this.form=this.container.getFirst("form");this.trigger=this.form.getFirst(".buttons button");this.spinner=this.form.getElement(".buttons .spinner");this.optimize=$("optimize");this.map=new PlanMyRoute.Map(this,$("google_map"));this.observeElements()},createAddressAfter:function(a){var b=a.container.clone();b.removeClass("first").removeClass("error");a.container.grab(b,"after");var c=b.getElement("input");c.set("value","");this.registerAddress(new PlanMyRoute.Address(c,this));this.reorderPlaceholders()},firstAddress:function(){var a=null;this.addresses.each(function(b){if(b.first){a=b}});return a},isOptimized:function(){return this.optimize.checked},observeElements:function(){this.form.addEvent("submit",function(a){a.stop()});this.trigger.addEvent("click",this.plan.bind(this))},plan:function(a){this.spinner.removeClass("hide");this.currentPlan=new PlanMyRoute.Plan(this);this.currentPlan.execute(this.routePlanned.bind(this))},registerAddress:function(a){this.addresses.push(a)},registerAddresses:function(){this.addresses=[];this.registerAddress(new PlanMyRoute.Address($$("#planning .start input")[0],this,true));$$("input.address").each(function(a){this.registerAddress(new PlanMyRoute.Address(a,this))}.bind(this))},reorderPlaceholders:function(){var a=1;this.form.getElements(".addresses input").each(function(b){b.set("name","address"+a);b.set("id","address"+a);b.set("placeholder","Address "+a);if(b.hasClass("placeholder")){b.set("value","Address "+a)}a++})},routePlanned:function(){this.spinner.addClass("hide")}});(function(){if(!this.Form){this.Form={}}var b=("placeholder" in document.createElement("input"));if(!("supportsPlaceholder" in this)&&this.supportsPlaceholder!==false&&b){this.Form.Placeholder=new Class({});return}this.Form.Placeholder=new Class({Implements:Options,options:{className:"placeholder",clearOnSubmit:false},initialize:function(d,a){this.setOptions(a);this.element=$(d);this.placeholder=this.element.get("placeholder");this.is_password=this.element.get("type")=="password"?true:false;this.activatePlaceholder();this.element.addEvents({focus:function(){this.deactivatePlaceholder()}.bind(this),blur:function(){this.activatePlaceholder()}.bind(this)});if(this.element.getParent("form")&&this.options.clearOnSubmit){this.element.getParent("form").addEvent("submit",function(c){if(this.element.get("value")==this.placeholder){this.element.set("value","")}}.bind(this))}},activatePlaceholder:function(){if(this.element.get("value")==""||this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","text")}this.element.addClass(this.options.className);this.element.set("value",this.placeholder)}},deactivatePlaceholder:function(){if(this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","password")}this.element.set("value","");this.element.removeClass(this.options.className)}}});Element.addEvent(window,"domready",function(a){$$("input[placeholder]").each(function(d){new Form.Placeholder(d)})})})();var PlanMyRoute={};var extensions={first:function(){return this[0]},last:function(){return this[this.length-1]}};for(var name in extensions){Array.implement(name,extensions[name]);Elements.implement(name,extensions[name])}PlanMyRoute.Address=new Class({initialize:function(f,d,e){this.element=f;this.route=d;this.start=e||false;this.coordinates=null,this.latitude=null,this.longitude=null,this.first=false,this.error=false;if(this.start){this.addStartMethods()}this.geocoder=this.route.geocoder;this.container=this.element.getParent(".set");this.assignElements();this.observeElements()},addAddress:function(b){this.route.createAddressAfter(this)},addStartMethods:function(){for(var b in PlanMyRoute.Address.StartMethods){this[b]=PlanMyRoute.Address.StartMethods[b].bind(this)}},assignElements:function(){this.makeFirstTrigger=this.container.getElement(".make_first");this.addAddressTrigger=this.container.getElement(".add");this.removeTrigger=this.container.getElement(".remove")},cachedLocationKey:function(){if(!this.hasText()){return""}return this.text().replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},distanceFrom:function(b){return this.geocoder.distanceFrom(this).to(b)},hasText:function(){var b=this.text();if(b==""||b==this.element.get("placeholder")){return false}return true},isCurrentLocationCached:function(){if(!this.hasText()){return false}var b=this.geocoder.addressLocationCache[this.cachedLocationKey()];if(b){this.coordinates=b}return !!b},isPlottable:function(){if(!this.coordinates){return false}return true},makeFirst:function(b){this.route.addresses.each(function(a){if(a!=this){a.container.removeClass("first");a.first=false}}.bind(this));this.container.toggleClass("first");this.first=!this.first},markError:function(){this.container.addClass("error");this.error=true},observeElements:function(){this.makeFirstTrigger.addEvent("click",this.makeFirst.bind(this));this.addAddressTrigger.addEvent("click",this.addAddress.bind(this));this.removeTrigger.addEvent("click",this.remove.bind(this))},remove:function(b){if(this.start){return false}if(this.route.addresses.length<=2){return false}this.container.dispose();this.route.addresses.erase(this);this.route.reorderPlaceholders()},removeErrors:function(){this.container.removeClass("error");this.error=false},retrieveCoordinates:function(b){if(!b){b=function(){}}if(this.hasText()&&!this.isCurrentLocationCached()){this.geocoder.geocodeFromAddress(this.text(),function(f,a){if(a==google.maps.GeocoderStatus.OK){var e=f[0].geometry.location;this.setCoordinates(e.lat(),e.lng());this.geocoder.cacheAddressLocation(this);this.removeErrors()}else{this.markError()}b()}.bind(this))}else{b();this.removeErrors()}},setCoordinates:function(c,d){this.coordinates=new PlanMyRoute.Coordinates(c,d);this.latitude=this.coordinates.latitude;this.longitude=this.coordinates.longitude},text:function(){return this.element.get("value").trim()}});PlanMyRoute.Address.StartMethods={assignElements:function(){},observeElements:function(){}};PlanMyRoute.Geocoder=new Class({initialize:function(){this._geocoder=new google.maps.Geocoder();this._addressForDistance=null;this.addressLocationCache={}},cacheAddressLocation:function(b){if(b.coordinates){this.addressLocationCache[b.cachedLocationKey()]=b.coordinates}},distanceFrom:function(b){this._addressForDistance=b;return this},geocode:function(d,c){return this._geocoder.geocode(d,c)},geocodeFromAddress:function(d,c){return this._geocoder.geocode({address:d},c)},geocodeFromCoordinates:function(d,c){return this._geocoder.geocode({latLng:d.latlng},c)},to:function(d){var e=this._addressForDistance.coordinates,f=d.coordinates;if(e&&f){return google.maps.geometry.spherical.computeDistanceBetween(e.latlng,f.latlng)}else{return null}}});PlanMyRoute.Coordinates=new Class({initialize:function(c,d){this.latitude=c;this.longitude=d;this.latlng=new google.maps.LatLng(this.latitude,this.longitude)}});PlanMyRoute.Map=new Class({initialize:function(c,d){this.route=c;this.container=d;this.element=this.container.getElement(".map");this.directionsPanel=this.container.getElement(".driving_directions");this.mapInitiated=false;this.mapLoaded=false;this.resetSources()},correctDirectionsMarkers:function(){setTimeout(function(){var b=this._sortImages(this.directionsPanel.getElements("img[src*=_green]"));if(!this.unwantedSrc.directions){this.unwantedSrc.directions=b.last().src}if(!this.desiredSrc.directions){this.desiredSrc.directions=b.first().src}b.each(function(a){if(a.src==this.unwantedSrc.directions){a.src=this.desiredSrc.directions}}.bind(this));if(this.mapLoaded){this.correctMapMarkers(true)}}.bind(this),1000)},correctMapMarkers:function(c){var d=function(){var a=this._sortImages(this.element.getElements("img[src*=_green]"));if(!this.unwantedSrc.map){this.unwantedSrc.map=a.last().src}if(!this.desiredSrc.map){this.desiredSrc.map=a.first().src}a.each(function(b){if(b.src==this.unwantedSrc.map){b.src=this.desiredSrc.map}}.bind(this))}.bind(this);if(c){d()}else{setTimeout(d,1000)}},resetSources:function(){this.desiredSrc={map:null,directions:null};this.unwantedSrc={map:null,directions:null}},mapDidLoad:function(){this.mapLoaded=true},plotAddresses:function(d,c){this.container.removeClass("hide");this.resetSources();if(!this.mapInitiated){this.map=new google.maps.Map(this.element,{center:d[0].coordinates.latlng,mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false});this.renderer=new google.maps.DirectionsRenderer({draggable:true,map:this.map,panel:this.directionsPanel,markerOptions:{draggable:false}});google.maps.event.addListener(this.renderer,"directions_changed",this.correctDirectionsMarkers.bind(this));google.maps.event.addListener(this.map,"tilesloaded",this.mapDidLoad.bind(this));google.maps.event.addListener(this.map,"idle",this.correctMapMarkers.bind(this));this.mapInitiated=true}new google.maps.DirectionsService().route(this.request(d),function(b,a){if(a==google.maps.DirectionsStatus.OK){this.renderer.setDirections(b)}if(c){c()}}.bind(this))},request:function(f){var g=f[0],e=f.slice(1,f.length),h={travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,waypoints:[]};h.origin=g.text();h.destination=g.text();e.each(function(a){h.waypoints.push({location:a.text(),stopover:true})});return h},_sortImages:function(f){var e=f.map(function(a){return a.src}),d=[];e=e.sort();e.each(function(a){f.each(function(b){if(b.src==a){d.push(b)}})});return d}});PlanMyRoute.Plan=new Class({initialize:function(b){this.route=b;this.geocoder=this.route.geocoder;this.map=this.route.map;this.addresses=[];this.totalGeocodeCount=0;this.geocodeCount=0},execute:function(b){this.callbackAfterMapping=b;this.geocodeAddresses()},geocodeAddresses:function(){this.totalGeocodeCount=this.route.addresses.length;this.geocodeCount=0;this.route.addresses.each(function(b){b.retrieveCoordinates(this.notifyGeocoding.bind(this))}.bind(this))},notifyGeocoding:function(){this.geocodeCount++;if(this.geocodeCount>=this.totalGeocodeCount){this.totalGeocodeCount=0;this.geocodeCount=0;this.selectPlottableAddresses();if(this.route.isOptimized()){this.orderAddresses()}if(this.addresses.length>1){this.map.plotAddresses(this.addresses,this.callbackAfterMapping)}else{this.callbackAfterMapping()}}},orderAddresses:function(){if(this.addresses.contains(this.route.startingAddress)){this.sortedAddresses=[this.route.startingAddress];this.addresses.erase(this.route.startingAddress);if(this.route.firstAddress()){var j=this.route.firstAddress();this.sortedAddresses.push(j);this.addresses.erase(j)}var f=this.addresses.length;for(var g=0;g<f;g++){var i=this.addresses.sort(this._sortingFunction.bind(this));var h=i[0];this.addresses.erase(h);this.sortedAddresses.push(h)}this.addresses=this.sortedAddresses}else{}},selectPlottableAddresses:function(){this.route.addresses.each(function(b){if(b.isPlottable()){this.addresses.push(b)}}.bind(this))},_sortingFunction:function(b,h){var i=this.sortedAddresses[this.sortedAddresses.length-1];var a=this.geocoder.distanceFrom(b).to(i),j=this.geocoder.distanceFrom(h).to(i);return a-j}});PlanMyRoute.Route=new Class({initialize:function(b){this.container=b;this.geocoder=new PlanMyRoute.Geocoder();this.registerAddresses();this.startingAddress=this.addresses[0];this.form=this.container.getFirst("form");this.trigger=this.form.getFirst(".buttons button");this.spinner=this.form.getElement(".buttons .spinner");this.optimize=$("optimize");this.map=new PlanMyRoute.Map(this,$("google_map"));this.observeElements()},createAddressAfter:function(f){var e=f.container.clone();e.removeClass("first").removeClass("error");f.container.grab(e,"after");var d=e.getElement("input");d.set("value","");this.registerAddress(new PlanMyRoute.Address(d,this));this.reorderPlaceholders()},firstAddress:function(){var b=null;this.addresses.each(function(a){if(a.first){b=a}});return b},isOptimized:function(){return this.optimize.checked},observeElements:function(){this.form.addEvent("submit",function(b){b.stop()});this.trigger.addEvent("click",this.plan.bind(this))},plan:function(b){this.spinner.removeClass("hide");this.currentPlan=new PlanMyRoute.Plan(this);this.currentPlan.execute(this.routePlanned.bind(this))},registerAddress:function(b){this.addresses.push(b)},registerAddresses:function(){this.addresses=[];this.registerAddress(new PlanMyRoute.Address($$("#planning .start input")[0],this,true));$$("input.address").each(function(b){this.registerAddress(new PlanMyRoute.Address(b,this))}.bind(this))},reorderPlaceholders:function(){var b=1;this.form.getElements(".addresses input").each(function(a){a.set("name","address"+b);a.set("id","address"+b);a.set("placeholder","Address "+b);if(a.hasClass("placeholder")){a.set("value","Address "+b)}b++})},routePlanned:function(){this.spinner.addClass("hide")}});(function(){if(!this.Form){this.Form={}}var a=("placeholder" in document.createElement("input"));if(!("supportsPlaceholder" in this)&&this.supportsPlaceholder!==false&&a){this.Form.Placeholder=new Class({});return}this.Form.Placeholder=new Class({Implements:Options,options:{className:"placeholder",clearOnSubmit:false},initialize:function(c,b){this.setOptions(b);this.element=$(c);this.placeholder=this.element.get("placeholder");this.is_password=this.element.get("type")=="password"?true:false;this.activatePlaceholder();this.element.addEvents({focus:function(){this.deactivatePlaceholder()}.bind(this),blur:function(){this.activatePlaceholder()}.bind(this)});if(this.element.getParent("form")&&this.options.clearOnSubmit){this.element.getParent("form").addEvent("submit",function(d){if(this.element.get("value")==this.placeholder){this.element.set("value","")}}.bind(this))}},activatePlaceholder:function(){if(this.element.get("value")==""||this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","text")}this.element.addClass(this.options.className);this.element.set("value",this.placeholder)}},deactivatePlaceholder:function(){if(this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","password")}this.element.set("value","");this.element.removeClass(this.options.className)}}});Element.addEvent(window,"domready",function(b){$$("input[placeholder]").each(function(c){new Form.Placeholder(c)})})})();var PlanMyRoute={};var extensions={first:function(){return this[0]},last:function(){return this[this.length-1]}};for(var name in extensions){Array.implement(name,extensions[name]);Elements.implement(name,extensions[name])}PlanMyRoute.Address=new Class({initialize:function(c,b,a){this.element=c;this.route=b;this.start=a||false;this.coordinates=null,this.latitude=null,this.longitude=null,this.first=false,this.error=false;if(this.start){this.addStartMethods()}this.geocoder=this.route.geocoder;this.container=this.element.getParent(".set");this.assignElements();this.observeElements()},addAddress:function(a){this.route.createAddressAfter(this)},addStartMethods:function(){for(var a in PlanMyRoute.Address.StartMethods){this[a]=PlanMyRoute.Address.StartMethods[a].bind(this)}},assignElements:function(){this.makeFirstTrigger=this.container.getElement(".make_first");this.addAddressTrigger=this.container.getElement(".add");this.removeTrigger=this.container.getElement(".remove")},cachedLocationKey:function(){if(!this.hasText()){return""}return this.text().replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},distanceFrom:function(a){return this.geocoder.distanceFrom(this).to(a)},hasText:function(){var a=this.text();if(a==""||a==this.element.get("placeholder")){return false}return true},isCurrentLocationCached:function(){if(!this.hasText()){return false}var a=this.geocoder.addressLocationCache[this.cachedLocationKey()];if(a){this.coordinates=a}return !!a},isPlottable:function(){if(!this.coordinates){return false}return true},makeFirst:function(a){this.route.addresses.each(function(b){if(b!=this){b.container.removeClass("first");b.first=false}}.bind(this));this.container.toggleClass("first");this.first=!this.first},markError:function(){this.container.addClass("error");this.error=true},observeElements:function(){this.makeFirstTrigger.addEvent("click",this.makeFirst.bind(this));this.addAddressTrigger.addEvent("click",this.addAddress.bind(this));this.removeTrigger.addEvent("click",this.remove.bind(this))},remove:function(a){if(this.start){return false}if(this.route.addresses.length<=2){return false}this.container.dispose();this.route.addresses.erase(this);this.route.reorderPlaceholders()},removeErrors:function(){this.container.removeClass("error");this.error=false},retrieveCoordinates:function(a){if(!a){a=function(){}}if(this.hasText()&&!this.isCurrentLocationCached()){this.geocoder.geocodeFromAddress(this.text(),function(c,b){if(b==google.maps.GeocoderStatus.OK){var d=c[0].geometry.location;this.setCoordinates(d.lat(),d.lng());this.geocoder.cacheAddressLocation(this);this.removeErrors()}else{this.markError()}a()}.bind(this))}else{a();this.removeErrors()}},setCoordinates:function(b,a){this.coordinates=new PlanMyRoute.Coordinates(b,a);this.latitude=this.coordinates.latitude;this.longitude=this.coordinates.longitude},text:function(){return this.element.get("value").trim()}});PlanMyRoute.Address.StartMethods={assignElements:function(){},observeElements:function(){}};PlanMyRoute.Geocoder=new Class({initialize:function(){this._geocoder=new google.maps.Geocoder();this._addressForDistance=null;this.addressLocationCache={}},cacheAddressLocation:function(a){if(a.coordinates){this.addressLocationCache[a.cachedLocationKey()]=a.coordinates}},distanceFrom:function(a){this._addressForDistance=a;return this},geocode:function(a,b){return this._geocoder.geocode(a,b)},geocodeFromAddress:function(a,b){return this._geocoder.geocode({address:a},b)},geocodeFromCoordinates:function(a,b){return this._geocoder.geocode({latLng:a.latlng},b)},to:function(b){var a=this._addressForDistance.coordinates,c=b.coordinates;if(a&&c){return google.maps.geometry.spherical.computeDistanceBetween(a.latlng,c.latlng)}else{return null}}});PlanMyRoute.Coordinates=new Class({initialize:function(b,a){this.latitude=b;this.longitude=a;this.latlng=new google.maps.LatLng(this.latitude,this.longitude)}});PlanMyRoute.Map=new Class({initialize:function(b,a){this.route=b;this.container=a;this.element=this.container.getElement(".map");this.directionsPanel=this.container.getElement(".driving_directions");this.mapInitiated=false;this.mapLoaded=false;this.resetSources()},correctDirectionsMarkers:function(){setTimeout(function(){var a=this._sortImages(this.directionsPanel.getElements("img[src*=_green]"));if(!this.unwantedSrc.directions){this.unwantedSrc.directions=a.last().src}if(!this.desiredSrc.directions){this.desiredSrc.directions=a.first().src}a.each(function(b){if(b.src==this.unwantedSrc.directions){b.src=this.desiredSrc.directions}}.bind(this));if(this.mapLoaded){this.correctMapMarkers(true)}}.bind(this),1000)},correctMapMarkers:function(b){var a=function(){var c=this._sortImages(this.element.getElements("img[src*=_green]"));if(!this.unwantedSrc.map){this.unwantedSrc.map=c.last().src}if(!this.desiredSrc.map){this.desiredSrc.map=c.first().src}c.each(function(d){if(d.src==this.unwantedSrc.map){d.src=this.desiredSrc.map}}.bind(this))}.bind(this);if(b){a()}else{setTimeout(a,1000)}},resetSources:function(){this.desiredSrc={map:null,directions:null};this.unwantedSrc={map:null,directions:null}},mapDidLoad:function(){this.mapLoaded=true},plotAddresses:function(a,b){this.container.removeClass("hide");this.resetSources();if(!this.mapInitiated){this.map=new google.maps.Map(this.element,{center:a[0].coordinates.latlng,mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false});this.renderer=new google.maps.DirectionsRenderer({draggable:true,map:this.map,panel:this.directionsPanel,markerOptions:{draggable:false}});google.maps.event.addListener(this.renderer,"directions_changed",this.correctDirectionsMarkers.bind(this));google.maps.event.addListener(this.map,"tilesloaded",this.mapDidLoad.bind(this));google.maps.event.addListener(this.map,"idle",this.correctMapMarkers.bind(this));this.mapInitiated=true}new google.maps.DirectionsService().route(this.request(a),function(c,d){if(d==google.maps.DirectionsStatus.OK){this.renderer.setDirections(c)}if(b){b()}}.bind(this))},request:function(a){var d=a[0],b=a.slice(1,a.length),c={travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,waypoints:[]};c.origin=d.text();c.destination=d.text();b.each(function(e){c.waypoints.push({location:e.text(),stopover:true})});return c},_sortImages:function(c){var a=c.map(function(d){return d.src}),b=[];a=a.sort();a.each(function(d){c.each(function(e){if(e.src==d){b.push(e)}})});return b}});PlanMyRoute.Plan=new Class({initialize:function(a){this.route=a;this.geocoder=this.route.geocoder;this.map=this.route.map;this.addresses=[];this.totalGeocodeCount=0;this.geocodeCount=0},execute:function(a){this.callbackAfterMapping=a;this.geocodeAddresses()},geocodeAddresses:function(){this.totalGeocodeCount=this.route.addresses.length;this.geocodeCount=0;this.route.addresses.each(function(a){a.retrieveCoordinates(this.notifyGeocoding.bind(this))}.bind(this))},notifyGeocoding:function(){this.geocodeCount++;if(this.geocodeCount>=this.totalGeocodeCount){this.totalGeocodeCount=0;this.geocodeCount=0;this.selectPlottableAddresses();if(this.route.isOptimized()){this.orderAddresses()}if(this.addresses.length>1){this.map.plotAddresses(this.addresses,this.callbackAfterMapping)}else{this.callbackAfterMapping()}}},orderAddresses:function(){if(this.addresses.contains(this.route.startingAddress)){this.sortedAddresses=[this.route.startingAddress];this.addresses.erase(this.route.startingAddress);if(this.route.firstAddress()){var c=this.route.firstAddress();this.sortedAddresses.push(c);this.addresses.erase(c)}var b=this.addresses.length;for(var a=0;a<b;a++){var d=this.addresses.sort(this._sortingFunction.bind(this));var e=d[0];this.addresses.erase(e);this.sortedAddresses.push(e)}this.addresses=this.sortedAddresses}else{}},selectPlottableAddresses:function(){this.route.addresses.each(function(a){if(a.isPlottable()){this.addresses.push(a)}}.bind(this))},_sortingFunction:function(f,e){var d=this.sortedAddresses[this.sortedAddresses.length-1];var g=this.geocoder.distanceFrom(f).to(d),c=this.geocoder.distanceFrom(e).to(d);return g-c}});PlanMyRoute.Route=new Class({initialize:function(a){this.container=a;this.geocoder=new PlanMyRoute.Geocoder();this.registerAddresses();this.startingAddress=this.addresses[0];this.form=this.container.getFirst("form");this.trigger=this.form.getFirst(".buttons button");this.spinner=this.form.getElement(".buttons .spinner");this.optimize=$("optimize");this.map=new PlanMyRoute.Map(this,$("google_map"));this.observeElements()},createAddressAfter:function(c){var a=c.container.clone();a.removeClass("first").removeClass("error");c.container.grab(a,"after");var b=a.getElement("input");b.set("value","");this.registerAddress(new PlanMyRoute.Address(b,this));this.reorderPlaceholders()},firstAddress:function(){var a=null;this.addresses.each(function(b){if(b.first){a=b}});return a},isOptimized:function(){return this.optimize.checked},observeElements:function(){this.form.addEvent("submit",function(a){a.stop()});this.trigger.addEvent("click",this.plan.bind(this))},plan:function(a){this.spinner.removeClass("hide");this.currentPlan=new PlanMyRoute.Plan(this);this.currentPlan.execute(this.routePlanned.bind(this))},registerAddress:function(a){this.addresses.push(a)},registerAddresses:function(){this.addresses=[];this.registerAddress(new PlanMyRoute.Address($$("#planning .start input")[0],this,true));$$("input.address").each(function(a){this.registerAddress(new PlanMyRoute.Address(a,this))}.bind(this))},reorderPlaceholders:function(){var a=1;this.form.getElements(".addresses input").each(function(b){b.set("name","address"+a);b.set("id","address"+a);b.set("placeholder","Address "+a);if(b.hasClass("placeholder")){b.set("value","Address "+a)}a++})},routePlanned:function(){this.spinner.addClass("hide")}});(function(){if(!this.Form){this.Form={}}var b=("placeholder" in document.createElement("input"));if(!("supportsPlaceholder" in this)&&this.supportsPlaceholder!==false&&b){this.Form.Placeholder=new Class({});return}this.Form.Placeholder=new Class({Implements:Options,options:{className:"placeholder",clearOnSubmit:false},initialize:function(d,a){this.setOptions(a);this.element=$(d);this.placeholder=this.element.get("placeholder");this.is_password=this.element.get("type")=="password"?true:false;this.activatePlaceholder();this.element.addEvents({focus:function(){this.deactivatePlaceholder()}.bind(this),blur:function(){this.activatePlaceholder()}.bind(this)});if(this.element.getParent("form")&&this.options.clearOnSubmit){this.element.getParent("form").addEvent("submit",function(c){if(this.element.get("value")==this.placeholder){this.element.set("value","")}}.bind(this))}},activatePlaceholder:function(){if(this.element.get("value")==""||this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","text")}this.element.addClass(this.options.className);this.element.set("value",this.placeholder)}},deactivatePlaceholder:function(){if(this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","password")}this.element.set("value","");this.element.removeClass(this.options.className)}}});Element.addEvent(window,"domready",function(a){$$("input[placeholder]").each(function(d){new Form.Placeholder(d)})})})();var PlanMyRoute={};var extensions={first:function(){return this[0]},last:function(){return this[this.length-1]}};for(var name in extensions){Array.implement(name,extensions[name]);Elements.implement(name,extensions[name])}PlanMyRoute.Address=new Class({initialize:function(d,e,f){this.element=d;this.route=e;this.start=f||false;this.coordinates=null,this.latitude=null,this.longitude=null,this.first=false,this.error=false;if(this.start){this.addStartMethods()}this.geocoder=this.route.geocoder;this.container=this.element.getParent(".set");this.assignElements();this.observeElements()},addAddress:function(b){this.route.createAddressAfter(this)},addStartMethods:function(){for(var b in PlanMyRoute.Address.StartMethods){this[b]=PlanMyRoute.Address.StartMethods[b].bind(this)}},assignElements:function(){this.makeFirstTrigger=this.container.getElement(".make_first");this.addAddressTrigger=this.container.getElement(".add");this.removeTrigger=this.container.getElement(".remove")},cachedLocationKey:function(){if(!this.hasText()){return""}return this.text().replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},distanceFrom:function(b){return this.geocoder.distanceFrom(this).to(b)},hasText:function(){var b=this.text();if(b==""||b==this.element.get("placeholder")){return false}return true},isCurrentLocationCached:function(){if(!this.hasText()){return false}var b=this.geocoder.addressLocationCache[this.cachedLocationKey()];if(b){this.coordinates=b}return !!b},isPlottable:function(){if(!this.coordinates){return false}return true},makeFirst:function(b){this.route.addresses.each(function(a){if(a!=this){a.container.removeClass("first");a.first=false}}.bind(this));this.container.toggleClass("first");this.first=!this.first},markError:function(){this.container.addClass("error");this.error=true},observeElements:function(){this.makeFirstTrigger.addEvent("click",this.makeFirst.bind(this));this.addAddressTrigger.addEvent("click",this.addAddress.bind(this));this.removeTrigger.addEvent("click",this.remove.bind(this))},remove:function(b){if(this.start){return false}if(this.route.addresses.length<=2){return false}this.container.dispose();this.route.addresses.erase(this);this.route.reorderPlaceholders()},removeErrors:function(){this.container.removeClass("error");this.error=false},retrieveCoordinates:function(b){if(!b){b=function(){}}if(this.hasText()&&!this.isCurrentLocationCached()){this.geocoder.geocodeFromAddress(this.text(),function(f,a){if(a==google.maps.GeocoderStatus.OK){var e=f[0].geometry.location;this.setCoordinates(e.lat(),e.lng());this.geocoder.cacheAddressLocation(this);this.removeErrors()}else{this.markError()}b()}.bind(this))}else{b();this.removeErrors()}},setCoordinates:function(c,d){this.coordinates=new PlanMyRoute.Coordinates(c,d);this.latitude=this.coordinates.latitude;this.longitude=this.coordinates.longitude},text:function(){return this.element.get("value").trim()}});PlanMyRoute.Address.StartMethods={assignElements:function(){},observeElements:function(){}};PlanMyRoute.Geocoder=new Class({initialize:function(){this._geocoder=new google.maps.Geocoder();this._addressForDistance=null;this.addressLocationCache={}},cacheAddressLocation:function(b){if(b.coordinates){this.addressLocationCache[b.cachedLocationKey()]=b.coordinates}},distanceFrom:function(b){this._addressForDistance=b;return this},geocode:function(d,c){return this._geocoder.geocode(d,c)},geocodeFromAddress:function(d,c){return this._geocoder.geocode({address:d},c)},geocodeFromCoordinates:function(d,c){return this._geocoder.geocode({latLng:d.latlng},c)},to:function(e){var f=this._addressForDistance.coordinates,d=e.coordinates;if(f&&d){return google.maps.geometry.spherical.computeDistanceBetween(f.latlng,d.latlng)}else{return null}}});PlanMyRoute.Coordinates=new Class({initialize:function(c,d){this.latitude=c;this.longitude=d;this.latlng=new google.maps.LatLng(this.latitude,this.longitude)}});PlanMyRoute.Map=new Class({initialize:function(c,d){this.route=c;this.container=d;this.element=this.container.getElement(".map");this.directionsPanel=this.container.getElement(".driving_directions");this.mapInitiated=false;this.mapLoaded=false;this.resetSources()},correctDirectionsMarkers:function(){setTimeout(function(){var b=this._sortImages(this.directionsPanel.getElements("img[src*=_green]"));if(!this.unwantedSrc.directions){this.unwantedSrc.directions=b.last().src}if(!this.desiredSrc.directions){this.desiredSrc.directions=b.first().src}b.each(function(a){if(a.src==this.unwantedSrc.directions){a.src=this.desiredSrc.directions}}.bind(this));if(this.mapLoaded){this.correctMapMarkers(true)}}.bind(this),1000)},correctMapMarkers:function(c){var d=function(){var a=this._sortImages(this.element.getElements("img[src*=_green]"));if(!this.unwantedSrc.map){this.unwantedSrc.map=a.last().src}if(!this.desiredSrc.map){this.desiredSrc.map=a.first().src}a.each(function(b){if(b.src==this.unwantedSrc.map){b.src=this.desiredSrc.map}}.bind(this))}.bind(this);if(c){d()}else{setTimeout(d,1000)}},resetSources:function(){this.desiredSrc={map:null,directions:null};this.unwantedSrc={map:null,directions:null}},mapDidLoad:function(){this.mapLoaded=true},plotAddresses:function(d,c){this.container.removeClass("hide");this.resetSources();if(!this.mapInitiated){this.map=new google.maps.Map(this.element,{center:d[0].coordinates.latlng,mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false});this.renderer=new google.maps.DirectionsRenderer({draggable:true,map:this.map,panel:this.directionsPanel,markerOptions:{draggable:false}});google.maps.event.addListener(this.renderer,"directions_changed",this.correctDirectionsMarkers.bind(this));google.maps.event.addListener(this.map,"tilesloaded",this.mapDidLoad.bind(this));google.maps.event.addListener(this.map,"idle",this.correctMapMarkers.bind(this));this.mapInitiated=true}new google.maps.DirectionsService().route(this.request(d),function(b,a){if(a==google.maps.DirectionsStatus.OK){this.renderer.setDirections(b)}if(c){c()}}.bind(this))},request:function(h){var e=h[0],g=h.slice(1,h.length),f={travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,waypoints:[]};f.origin=e.text();f.destination=e.text();g.each(function(a){f.waypoints.push({location:a.text(),stopover:true})});return f},_sortImages:function(d){var f=d.map(function(a){return a.src}),e=[];f=f.sort();f.each(function(a){d.each(function(b){if(b.src==a){e.push(b)}})});return e}});PlanMyRoute.Plan=new Class({initialize:function(b){this.route=b;this.geocoder=this.route.geocoder;this.map=this.route.map;this.addresses=[];this.totalGeocodeCount=0;this.geocodeCount=0},execute:function(b){this.callbackAfterMapping=b;this.geocodeAddresses()},geocodeAddresses:function(){this.totalGeocodeCount=this.route.addresses.length;this.geocodeCount=0;this.route.addresses.each(function(b){b.retrieveCoordinates(this.notifyGeocoding.bind(this))}.bind(this))},notifyGeocoding:function(){this.geocodeCount++;if(this.geocodeCount>=this.totalGeocodeCount){this.totalGeocodeCount=0;this.geocodeCount=0;this.selectPlottableAddresses();if(this.route.isOptimized()){this.orderAddresses()}if(this.addresses.length>1){this.map.plotAddresses(this.addresses,this.callbackAfterMapping)}else{this.callbackAfterMapping()}}},orderAddresses:function(){if(this.addresses.contains(this.route.startingAddress)){this.sortedAddresses=[this.route.startingAddress];this.addresses.erase(this.route.startingAddress);if(this.route.firstAddress()){var h=this.route.firstAddress();this.sortedAddresses.push(h);this.addresses.erase(h)}var i=this.addresses.length;for(var j=0;j<i;j++){var g=this.addresses.sort(this._sortingFunction.bind(this));var f=g[0];this.addresses.erase(f);this.sortedAddresses.push(f)}this.addresses=this.sortedAddresses}else{}},selectPlottableAddresses:function(){this.route.addresses.each(function(b){if(b.isPlottable()){this.addresses.push(b)}}.bind(this))},_sortingFunction:function(i,j){var a=this.sortedAddresses[this.sortedAddresses.length-1];var h=this.geocoder.distanceFrom(i).to(a),b=this.geocoder.distanceFrom(j).to(a);return h-b}});PlanMyRoute.Route=new Class({initialize:function(b){this.container=b;this.geocoder=new PlanMyRoute.Geocoder();this.registerAddresses();this.startingAddress=this.addresses[0];this.form=this.container.getFirst("form");this.trigger=this.form.getFirst(".buttons button");this.spinner=this.form.getElement(".buttons .spinner");this.optimize=$("optimize");this.map=new PlanMyRoute.Map(this,$("google_map"));this.observeElements()},createAddressAfter:function(d){var f=d.container.clone();f.removeClass("first").removeClass("error");d.container.grab(f,"after");var e=f.getElement("input");e.set("value","");this.registerAddress(new PlanMyRoute.Address(e,this));this.reorderPlaceholders()},firstAddress:function(){var b=null;this.addresses.each(function(a){if(a.first){b=a}});return b},isOptimized:function(){return this.optimize.checked},observeElements:function(){this.form.addEvent("submit",function(b){b.stop()});this.trigger.addEvent("click",this.plan.bind(this))},plan:function(b){this.spinner.removeClass("hide");this.currentPlan=new PlanMyRoute.Plan(this);this.currentPlan.execute(this.routePlanned.bind(this))},registerAddress:function(b){this.addresses.push(b)},registerAddresses:function(){this.addresses=[];this.registerAddress(new PlanMyRoute.Address($$("#planning .start input")[0],this,true));$$("input.address").each(function(b){this.registerAddress(new PlanMyRoute.Address(b,this))}.bind(this))},reorderPlaceholders:function(){var b=1;this.form.getElements(".addresses input").each(function(a){a.set("name","address"+b);a.set("id","address"+b);a.set("placeholder","Address "+b);if(a.hasClass("placeholder")){a.set("value","Address "+b)}b++})},routePlanned:function(){this.spinner.addClass("hide")}});(function(){if(!this.Form){this.Form={}}var a=("placeholder" in document.createElement("input"));if(!("supportsPlaceholder" in this)&&this.supportsPlaceholder!==false&&a){this.Form.Placeholder=new Class({});return}this.Form.Placeholder=new Class({Implements:Options,options:{className:"placeholder",clearOnSubmit:false},initialize:function(c,b){this.setOptions(b);this.element=$(c);this.placeholder=this.element.get("placeholder");this.is_password=this.element.get("type")=="password"?true:false;this.activatePlaceholder();this.element.addEvents({focus:function(){this.deactivatePlaceholder()}.bind(this),blur:function(){this.activatePlaceholder()}.bind(this)});if(this.element.getParent("form")&&this.options.clearOnSubmit){this.element.getParent("form").addEvent("submit",function(d){if(this.element.get("value")==this.placeholder){this.element.set("value","")}}.bind(this))}},activatePlaceholder:function(){if(this.element.get("value")==""||this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","text")}this.element.addClass(this.options.className);this.element.set("value",this.placeholder)}},deactivatePlaceholder:function(){if(this.element.get("value")==this.placeholder){if(this.is_password){this.element.set("type","password")}this.element.set("value","");this.element.removeClass(this.options.className)}}});Element.addEvent(window,"domready",function(b){$$("input[placeholder]").each(function(c){new Form.Placeholder(c)})})})();var PlanMyRoute={};var extensions={first:function(){return this[0]},last:function(){return this[this.length-1]}};for(var name in extensions){Array.implement(name,extensions[name]);Elements.implement(name,extensions[name])}PlanMyRoute.Address=new Class({initialize:function(b,a,c){this.element=b;this.route=a;this.start=c||false;this.coordinates=null,this.latitude=null,this.longitude=null,this.first=false,this.error=false;if(this.start){this.addStartMethods()}this.geocoder=this.route.geocoder;this.container=this.element.getParent(".set");this.assignElements();this.observeElements()},addAddress:function(a){this.route.createAddressAfter(this)},addStartMethods:function(){for(var a in PlanMyRoute.Address.StartMethods){this[a]=PlanMyRoute.Address.StartMethods[a].bind(this)}},assignElements:function(){this.makeFirstTrigger=this.container.getElement(".make_first");this.addAddressTrigger=this.container.getElement(".add");this.removeTrigger=this.container.getElement(".remove")},cachedLocationKey:function(){if(!this.hasText()){return""}return this.text().replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},distanceFrom:function(a){return this.geocoder.distanceFrom(this).to(a)},hasText:function(){var a=this.text();if(a==""||a==this.element.get("placeholder")){return false}return true},isCurrentLocationCached:function(){if(!this.hasText()){return false}var a=this.geocoder.addressLocationCache[this.cachedLocationKey()];if(a){this.coordinates=a}return !!a},isPlottable:function(){if(!this.coordinates){return false}return true},makeFirst:function(a){this.route.addresses.each(function(b){if(b!=this){b.container.removeClass("first");b.first=false}}.bind(this));this.container.toggleClass("first");this.first=!this.first},markError:function(){this.container.addClass("error");this.error=true},observeElements:function(){this.makeFirstTrigger.addEvent("click",this.makeFirst.bind(this));this.addAddressTrigger.addEvent("click",this.addAddress.bind(this));this.removeTrigger.addEvent("click",this.remove.bind(this))},remove:function(a){if(this.start){return false}if(this.route.addresses.length<=2){return false}this.container.dispose();this.route.addresses.erase(this);this.route.reorderPlaceholders()},removeErrors:function(){this.container.removeClass("error");this.error=false},retrieveCoordinates:function(a){if(!a){a=function(){}}if(this.hasText()&&!this.isCurrentLocationCached()){this.geocoder.geocodeFromAddress(this.text(),function(c,b){if(b==google.maps.GeocoderStatus.OK){var d=c[0].geometry.location;this.setCoordinates(d.lat(),d.lng());this.geocoder.cacheAddressLocation(this);this.removeErrors()}else{this.markError()}a()}.bind(this))}else{a();this.removeErrors()}},setCoordinates:function(b,a){this.coordinates=new PlanMyRoute.Coordinates(b,a);this.latitude=this.coordinates.latitude;this.longitude=this.coordinates.longitude},text:function(){return this.element.get("value").trim()}});PlanMyRoute.Address.StartMethods={assignElements:function(){},observeElements:function(){}};PlanMyRoute.Geocoder=new Class({initialize:function(){this._geocoder=new google.maps.Geocoder();this._addressForDistance=null;this.addressLocationCache={}},cacheAddressLocation:function(a){if(a.coordinates){this.addressLocationCache[a.cachedLocationKey()]=a.coordinates}},distanceFrom:function(a){this._addressForDistance=a;return this},geocode:function(a,b){return this._geocoder.geocode(a,b)},geocodeFromAddress:function(a,b){return this._geocoder.geocode({address:a},b)},geocodeFromCoordinates:function(a,b){return this._geocoder.geocode({latLng:a.latlng},b)},to:function(a){var c=this._addressForDistance.coordinates,b=a.coordinates;if(c&&b){return google.maps.geometry.spherical.computeDistanceBetween(c.latlng,b.latlng)}else{return null}}});PlanMyRoute.Coordinates=new Class({initialize:function(b,a){this.latitude=b;this.longitude=a;this.latlng=new google.maps.LatLng(this.latitude,this.longitude)}});PlanMyRoute.Map=new Class({initialize:function(b,a){this.route=b;this.container=a;this.element=this.container.getElement(".map");this.directionsPanel=this.container.getElement(".driving_directions");this.mapInitiated=false;this.mapLoaded=false;this.resetSources()},correctDirectionsMarkers:function(){setTimeout(function(){var a=this._sortImages(this.directionsPanel.getElements("img[src*=_green]"));if(!this.unwantedSrc.directions){this.unwantedSrc.directions=a.last().src}if(!this.desiredSrc.directions){this.desiredSrc.directions=a.first().src}a.each(function(b){if(b.src==this.unwantedSrc.directions){b.src=this.desiredSrc.directions}}.bind(this));if(this.mapLoaded){this.correctMapMarkers(true)}}.bind(this),1000)},correctMapMarkers:function(b){var a=function(){var c=this._sortImages(this.element.getElements("img[src*=_green]"));if(!this.unwantedSrc.map){this.unwantedSrc.map=c.last().src}if(!this.desiredSrc.map){this.desiredSrc.map=c.first().src}c.each(function(d){if(d.src==this.unwantedSrc.map){d.src=this.desiredSrc.map}}.bind(this))}.bind(this);if(b){a()}else{setTimeout(a,1000)}},resetSources:function(){this.desiredSrc={map:null,directions:null};this.unwantedSrc={map:null,directions:null}},mapDidLoad:function(){this.mapLoaded=true},plotAddresses:function(a,b){this.container.removeClass("hide");this.resetSources();if(!this.mapInitiated){this.map=new google.maps.Map(this.element,{center:a[0].coordinates.latlng,mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false});this.renderer=new google.maps.DirectionsRenderer({draggable:true,map:this.map,panel:this.directionsPanel,markerOptions:{draggable:false}});google.maps.event.addListener(this.renderer,"directions_changed",this.correctDirectionsMarkers.bind(this));google.maps.event.addListener(this.map,"tilesloaded",this.mapDidLoad.bind(this));google.maps.event.addListener(this.map,"idle",this.correctMapMarkers.bind(this));this.mapInitiated=true}new google.maps.DirectionsService().route(this.request(a),function(c,d){if(d==google.maps.DirectionsStatus.OK){this.renderer.setDirections(c)}if(b){b()}}.bind(this))},request:function(c){var b=c[0],d=c.slice(1,c.length),a={travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,waypoints:[]};a.origin=b.text();a.destination=b.text();d.each(function(e){a.waypoints.push({location:e.text(),stopover:true})});return a},_sortImages:function(b){var c=b.map(function(d){return d.src}),a=[];c=c.sort();c.each(function(d){b.each(function(e){if(e.src==d){a.push(e)}})});return a}});PlanMyRoute.Plan=new Class({initialize:function(a){this.route=a;this.geocoder=this.route.geocoder;this.map=this.route.map;this.addresses=[];this.totalGeocodeCount=0;this.geocodeCount=0},execute:function(a){this.callbackAfterMapping=a;this.geocodeAddresses()},geocodeAddresses:function(){this.totalGeocodeCount=this.route.addresses.length;this.geocodeCount=0;this.route.addresses.each(function(a){a.retrieveCoordinates(this.notifyGeocoding.bind(this))}.bind(this))},notifyGeocoding:function(){this.geocodeCount++;if(this.geocodeCount>=this.totalGeocodeCount){this.totalGeocodeCount=0;this.geocodeCount=0;this.selectPlottableAddresses();if(this.route.isOptimized()){this.orderAddresses()}if(this.addresses.length>1){this.map.plotAddresses(this.addresses,this.callbackAfterMapping)}else{this.callbackAfterMapping()}}},orderAddresses:function(){if(this.addresses.contains(this.route.startingAddress)){this.sortedAddresses=[this.route.startingAddress];this.addresses.erase(this.route.startingAddress);if(this.route.firstAddress()){var e=this.route.firstAddress();this.sortedAddresses.push(e);this.addresses.erase(e)}var d=this.addresses.length;for(var c=0;c<d;c++){var a=this.addresses.sort(this._sortingFunction.bind(this));var b=a[0];this.addresses.erase(b);this.sortedAddresses.push(b)}this.addresses=this.sortedAddresses}else{}},selectPlottableAddresses:function(){this.route.addresses.each(function(a){if(a.isPlottable()){this.addresses.push(a)}}.bind(this))},_sortingFunction:function(d,c){var g=this.sortedAddresses[this.sortedAddresses.length-1];var e=this.geocoder.distanceFrom(d).to(g),f=this.geocoder.distanceFrom(c).to(g);return e-f}});PlanMyRoute.Route=new Class({initialize:function(a){this.container=a;this.geocoder=new PlanMyRoute.Geocoder();this.registerAddresses();this.startingAddress=this.addresses[0];this.assignElements();this.observeElements()},assignElements:function(){this.form=this.container.getFirst("form");this.trigger=this.form.getFirst(".buttons button");this.spinner=this.form.getElement(".buttons .spinner");this.optimize=$("optimize");this.map=new PlanMyRoute.Map(this,$("google_map"));this.printContainer=$("print");this.printTextTrigger=this.printContainer.getElement("button.print_text");this.printAllTrigger=this.printContainer.getElement("button.print_all")},createAddressAfter:function(b){var c=b.container.clone();c.removeClass("first").removeClass("error");b.container.grab(c,"after");var a=c.getElement("input");a.set("value","");this.registerAddress(new PlanMyRoute.Address(a,this));this.reorderPlaceholders()},firstAddress:function(){var a=null;this.addresses.each(function(b){if(b.first){a=b}});return a},isOptimized:function(){return this.optimize.checked},observeElements:function(){this.form.addEvent("submit",function(a){a.stop()});this.trigger.addEvent("click",this.plan.bind(this));this.printTextTrigger.addEvent("click",this.printText.bind(this));this.printAllTrigger.addEvent("click",this.printAll.bind(this))},plan:function(a){this.spinner.removeClass("hide");this.currentPlan=new PlanMyRoute.Plan(this);this.currentPlan.execute(this.routePlanned.bind(this))},print:function(a){if(a){setTimeout(a,300)}window.print()},printAll:function(a){this.print()},printText:function(a){this.map.container.addClass("print_text");this.print(function(){this.map.container.removeClass("print_text")}.bind(this))},registerAddress:function(a){this.addresses.push(a)},registerAddresses:function(){this.addresses=[];this.registerAddress(new PlanMyRoute.Address($$("#planning .start input")[0],this,true));$$("input.address").each(function(a){this.registerAddress(new PlanMyRoute.Address(a,this))}.bind(this))},reorderPlaceholders:function(){var a=1;this.form.getElements(".addresses input").each(function(b){b.set("name","address"+a);b.set("id","address"+a);b.set("placeholder","Address "+a);if(b.hasClass("placeholder")){b.set("value","Address "+a)}a++})},routePlanned:function(){this.spinner.addClass("hide");this.printContainer.removeClass("hide")}});